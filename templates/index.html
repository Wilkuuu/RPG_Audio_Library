<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Audio Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .audio-card {
            transition: transform 0.2s;
        }
        .audio-card:hover {
            transform: scale(1.02);
        }
        .playing {
            background-color: #e3f2fd;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">RPG Audio Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-bs-toggle="tab" data-bs-target="#samples">Samples</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="tab" data-bs-target="#scenes">Scenes</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="mb-3" id="audioPlayerContainer" style="display:none;">
            <audio id="audioPlayer" controls style="width:100%">
                Your browser does not support the audio element.
            </audio>
            <div class="d-flex justify-content-between">
                <span id="audioCurrentTime">0:00</span>
                <span id="audioDuration">0:00</span>
                <button class="btn btn-secondary btn-sm" onclick="stopAudio()">Stop</button>
            </div>
        </div>
        <div class="tab-content">
            <!-- Samples Tab -->
            <div class="tab-pane fade show active" id="samples">
                <div class="row mb-4">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload"></i> Upload Sample
                        </button>
                    </div>
                </div>
                <div class="row" id="samplesList">
                    <!-- Samples will be loaded here -->
                </div>
            </div>

            <!-- Scenes Tab -->
            <div class="tab-pane fade" id="scenes">
                <div class="row mb-4">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sceneModal">
                            <i class="fas fa-plus"></i> Create Scene
                        </button>
                    </div>
                </div>
                <div class="row" id="scenesList">
                    <!-- Scenes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Audio Sample</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" name="category">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Audio File</label>
                            <input type="file" class="form-control" name="file" accept=".mp3,.wav,.ogg" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" name="is_one_shot" id="isOneShot">
                            <label class="form-check-label" for="isOneShot">One-shot sample</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="uploadSample()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scene Modal -->
    <div class="modal fade" id="sceneModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Scene</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sceneForm">
                        <div class="mb-3">
                            <label class="form-label">Scene Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Samples</label>
                            <div id="sceneSamplesList">
                                <!-- Available samples will be listed here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createScene()">Create Scene</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentAudio = null;
        let samplesCache = [];
        let currentAudioUrl = null;
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const audioCurrentTime = document.getElementById('audioCurrentTime');
        const audioDuration = document.getElementById('audioDuration');

        document.addEventListener('DOMContentLoaded', () => {
            loadSamples();
            loadScenes();
            setupAudioPlayer();
        });

        function setupAudioPlayer() {
            audioPlayer.addEventListener('timeupdate', () => {
                audioCurrentTime.textContent = formatTime(audioPlayer.currentTime);
            });
            audioPlayer.addEventListener('durationchange', () => {
                audioDuration.textContent = formatTime(audioPlayer.duration);
            });
            audioPlayer.addEventListener('ended', () => {
                audioPlayerContainer.style.display = 'none';
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function stopAudio() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayerContainer.style.display = 'none';
        }

        async function loadSamples() {
            try {
                const response = await fetch('/api/samples');
                const samples = await response.json();
                samplesCache = samples;
                const samplesList = document.getElementById('samplesList');
                samplesList.innerHTML = samples.map(sample => `
                    <div class="col-md-4 mb-4">
                        <div class="card audio-card">
                            <div class="card-body">
                                <h5 class="card-title">${sample.name}</h5>
                                <p class="card-text">
                                    Category: ${sample.category}<br>
                                    Type: ${sample.is_one_shot ? 'One-shot' : 'Loop'}
                                </p>
                                <audio id="audio-${sample._id}" controls style="width:100%">
                                    <source src="/api/audio/${sample.filename}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="d-flex justify-content-between mt-2">
                                    <button class="btn btn-danger btn-sm" onclick="deleteSample('${sample._id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                populateSceneSamplesList();
            } catch (error) {
                console.error('Error loading samples:', error);
            }
        }

        async function uploadSample() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/samples', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    form.reset();
                    loadSamples();
                } else {
                    alert('Error uploading sample');
                }
            } catch (error) {
                console.error('Error uploading sample:', error);
                alert('Error uploading sample');
            }
        }

        async function deleteSample(sampleId) {
            if (!confirm('Are you sure you want to delete this sample?')) return;

            try {
                const response = await fetch(`/api/samples/${sampleId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadSamples();
                } else {
                    alert('Error deleting sample');
                }
            } catch (error) {
                console.error('Error deleting sample:', error);
                alert('Error deleting sample');
            }
        }

        function populateSceneSamplesList() {
            const sceneSamplesList = document.getElementById('sceneSamplesList');
            if (!sceneSamplesList) return;
            sceneSamplesList.innerHTML = samplesCache.map(sample => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${sample._id}" id="scene-sample-${sample._id}" name="scene_samples">
                    <label class="form-check-label" for="scene-sample-${sample._id}">
                        ${sample.name} (${sample.category})
                    </label>
                </div>
            `).join('');
        }

        async function loadScenes() {
            try {
                const response = await fetch('/api/scenes');
                const scenes = await response.json();
                const scenesList = document.getElementById('scenesList');
                scenesList.innerHTML = scenes.map(scene => `
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${scene.name}</h5>
                                <p class="card-text">${scene.description || ''}</p>
                                <button class="btn btn-primary btn-sm" onclick="playScene('${scene._id}')">
                                    <i class="fas fa-play"></i> Play Scene
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading scenes:', error);
            }
        }

        async function createScene() {
            const form = document.getElementById('sceneForm');
            const formData = new FormData(form);
            const selectedSamples = Array.from(document.querySelectorAll('input[name="scene_samples"]:checked')).map(cb => cb.value);
            const sceneData = {
                name: formData.get('name'),
                description: formData.get('description'),
                samples: selectedSamples
            };
            try {
                const response = await fetch('/api/scenes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sceneData)
                });
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('sceneModal')).hide();
                    form.reset();
                    loadScenes();
                } else {
                    alert('Error creating scene');
                }
            } catch (error) {
                console.error('Error creating scene:', error);
                alert('Error creating scene');
            }
        }

        async function playScene(sceneId) {
            const response = await fetch('/api/scenes');
            const scenes = await response.json();
            const scene = scenes.find(s => s._id === sceneId);
            if (scene && scene.samples && scene.samples.length > 0) {
                const sample = samplesCache.find(s => s._id === scene.samples[0]);
                if (sample) {
                    const audioElement = document.getElementById(`audio-${sample._id}`);
                    if (audioElement) audioElement.play();
                }
            } else {
                alert('No samples in this scene.');
            }
        }
    </script>
</body>
</html>