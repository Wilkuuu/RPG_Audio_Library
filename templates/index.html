<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Audio Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2c3e50;
            --accent-color: #3498db;
            --text-color: #ecf0f1;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --danger-color: #e74c3c;
            --sidebar-width: 300px;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-right: var(--sidebar-width);
        }

        .navbar {
            background-color: var(--secondary-bg) !important;
            border-bottom: 2px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .soundset-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .soundset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .mood-section {
            background: rgba(44, 62, 80, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .element-card {
            background: var(--secondary-bg);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
            cursor: default;
        }

        .element-card:hover {
            background: var(--accent-color);
        }

        .element-card.playing {
            background: var(--accent-color);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }

        .element-checkbox {
            margin-right: 10px;
        }

        .element-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .element-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .element-list-item:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .element-list-item.playing {
            background: rgba(52, 152, 219, 0.15);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }

        .element-list-item .element-info {
            flex-grow: 1;
            margin-left: 10px;
        }

        .element-list-item .element-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .element-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            transform: translateY(-1px);
        }

        .circular-progress {
            position: relative;
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .circular-progress circle {
            fill: none;
            stroke-width: 3;
        }

        .circular-progress .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .circular-progress .progress {
            stroke: var(--accent-color);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }

        .element-volume {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }

        .element-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .element-volume::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .delay-range {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 6px;
        }

        .delay-range input {
            width: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .element-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }

        .element-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }

        .right-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(26, 26, 26, 0.95);
            border-left: 2px solid var(--accent-color);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header {
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h5 {
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .master-volume-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .master-volume-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .master-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .master-volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .volume-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        .playing-sounds {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .playing-sound-item {
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            padding: 15px;
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s;
        }

        .playing-sound-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playing-sound-info {
            flex-grow: 1;
            margin-right: 10px;
        }

        .playing-sound-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .playing-sound-category {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .playing-sound-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        .playing-sound-timeline {
            flex-grow: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .playing-sound-timeline:hover {
            height: 6px;
        }

        .playing-sound-timeline:hover .playing-sound-progress {
            height: 6px;
        }

        .playing-sound-progress {
            position: absolute;
            height: 100%;
            background: var(--accent-color);
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        .playing-sound-timeline::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 12px;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .playing-sound-timeline.seeking .playing-sound-progress {
            background: #2980b9;
        }

        .playing-sound-time {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            min-width: 80px;
            text-align: right;
        }

        .playing-sound-buttons {
            display: flex;
            gap: 5px;
        }

        .playing-sound-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            transition: all 0.2s;
        }

        .playing-sound-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .playing-sound-button.active {
            background: var(--accent-color);
        }

        .playing-sound-button.danger {
            background: var(--danger-color);
        }

        .playing-sound-button.danger:hover {
            background: #c0392b;
        }

        .container {
            max-width: calc(100% - var(--sidebar-width));
        }

        /* Remove the old master controls */
        .master-controls {
            display: none;
        }

        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
        }

        .nav-tabs .nav-link.active {
            background-color: var(--accent-color);
            color: white;
            border-radius: 4px;
        }

        .one-shot-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background: var(--accent-color);
            border: none;
        }

        .one-shot-button:hover {
            transform: scale(1.1);
            background: #2980b9;
        }

        .one-shot-button.active {
            background: var(--danger-color);
        }

        .one-shot-button.active:hover {
            background: #c0392b;
        }

        .alert-info {
            background-color: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.2);
            color: var(--text-color);
            border-radius: 6px;
            padding: 10px 15px;
            margin-top: 15px;
        }

        .section-title {
            margin: 20px 0 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title h4 {
            color: var(--accent-color);
            font-size: 1.2em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h4 i {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">RPG Audio Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="nav nav-tabs ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" id="soundsets-tab" data-bs-toggle="tab" href="#soundsets" role="tab">Soundsets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="scenes-tab" data-bs-toggle="tab" href="#scenes" role="tab">Scenes</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <div class="sidebar-header">
            <h4>Audio Controls</h4>
        </div>
        
        <div class="sidebar-section">
            <h5>Master Volume</h5>
            <div class="master-volume-container">
                <input type="range" class="master-volume-slider" id="masterVolume" min="0" max="100" value="100">
                <div class="volume-value">
                    <span>Volume</span>
                    <span id="masterVolumeValue">100%</span>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <h5>Currently Playing</h5>
            <div class="playing-sounds" id="playingSounds">
                <!-- Playing sounds will be listed here -->
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="tab-content">
            <!-- Soundsets Tab -->
            <div class="tab-pane fade show active" id="soundsets" role="tabpanel">
                <div class="row mb-4">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="fas fa-upload"></i> Upload Sound
                        </button>
                    </div>
                </div>
                <div id="soundsetsContainer">
                    <!-- Soundsets will be loaded here -->
                </div>
            </div>

            <!-- Scenes Tab -->
            <div class="tab-pane fade" id="scenes" role="tabpanel">
                <div class="row mb-4">
                    <div class="col">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sceneModal">
                            <i class="fas fa-plus"></i> Create Scene
                        </button>
                    </div>
                </div>
                <div class="row" id="scenesList">
                    <!-- Scenes will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Sound</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control bg-dark text-light" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select bg-dark text-light" name="category" required>
                                <option value="ambient">Ambient</option>
                                <option value="battle">Battle</option>
                                <option value="town">Town</option>
                                <option value="dungeon">Dungeon</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Sound File</label>
                            <input type="file" class="form-control bg-dark text-light" name="file" accept=".mp3,.wav,.ogg" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" name="is_one_shot" id="isOneShot">
                            <label class="form-check-label" for="isOneShot">One-shot sound</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="uploadSample()">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scene Modal -->
    <div class="modal fade" id="sceneModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Create Scene</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sceneForm">
                        <div class="mb-3">
                            <label class="form-label">Scene Name</label>
                            <input type="text" class="form-control bg-dark text-light" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control bg-dark text-light" name="description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Scene Type</label>
                            <select class="form-select bg-dark text-light" name="scene_type" id="sceneType">
                                <option value="ambient">Ambient</option>
                                <option value="battle">Battle</option>
                                <option value="town">Town</option>
                                <option value="dungeon">Dungeon</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Sounds</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="suggestSamples()">
                                            <i class="fas fa-magic"></i> AI Suggest Sounds
                                        </button>
                                    </div>
                                    <div id="sceneSamplesList" class="border border-secondary p-2" style="max-height: 300px; overflow-y: auto;">
                                        <!-- Available samples will be listed here -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Selected Sounds</h6>
                                    <div id="selectedSamplesList" class="border border-secondary p-2" style="max-height: 300px; overflow-y: auto;">
                                        <!-- Selected samples will be shown here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createScene()">Create Scene</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this sample? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Scene Confirmation Modal -->
    <div class="modal fade" id="deleteSceneModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete Scene</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this scene? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteSceneBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Sound</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editSampleId" name="id">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control bg-dark text-light" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select bg-dark text-light" id="editCategory" name="category" required>
                                <option value="ambient">Ambient</option>
                                <option value="battle">Battle</option>
                                <option value="town">Town</option>
                                <option value="dungeon">Dungeon</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editIsOneShot" name="is_one_shot">
                            <label class="form-check-label" for="editIsOneShot">One-shot sound</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateSample()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentlyPlaying = new Map();
        const masterVolume = document.getElementById('masterVolume');
        const playingSounds = document.getElementById('playingSounds');

        document.addEventListener('DOMContentLoaded', () => {
            loadSamples();
            loadScenes();
            setupMasterVolume();
        });

        function setupMasterVolume() {
            const masterVolume = document.getElementById('masterVolume');
            masterVolume.addEventListener('input', (e) => {
                const volume = e.target.value / 100;
                document.querySelectorAll('audio').forEach(audio => {
                    audio.volume = volume;
                });
                // Update volume display
                document.getElementById('masterVolumeValue').textContent = `${Math.round(e.target.value)}%`;
            });
        }

        let lastUpdateTime = 0;
        const UPDATE_INTERVAL = 500; // Only update every 500ms

        function updatePlayingSounds() {
            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_INTERVAL) {
                return; // Skip update if not enough time has passed
            }
            lastUpdateTime = now;

            // Get current playing sounds
            const currentSounds = Array.from(currentlyPlaying.entries());
            
            // Update existing elements or create new ones
            currentSounds.forEach(([id, name]) => {
                const sample = samplesCache.find(s => s._id === id);
                const audio = document.getElementById(`audio-${id}`);
                if (!audio) return;

                const isPaused = audio.paused;
                const progress = (audio.currentTime / audio.duration) * 100 || 0;

                // Check if element already exists
                let soundItem = document.querySelector(`.playing-sound-item[data-id="${id}"]`);
                
                if (!soundItem) {
                    // Create new element if it doesn't exist
                    soundItem = document.createElement('div');
                    soundItem.className = 'playing-sound-item';
                    soundItem.setAttribute('data-id', id);
                    soundItem.innerHTML = `
                        <div class="playing-sound-header">
                            <div class="playing-sound-info">
                                <div class="playing-sound-name">${name}</div>
                                <div class="playing-sound-category">${sample ? sample.category : ''}</div>
                            </div>
                            <div class="playing-sound-buttons">
                                <button class="playing-sound-button ${isPaused ? '' : 'active'}" 
                                        onclick="togglePlayPause('${id}')">
                                    <i class="fas fa-${isPaused ? 'play' : 'pause'}"></i>
                                </button>
                                <button class="playing-sound-button danger" onclick="stopSound('${id}')">
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                        </div>
                        <div class="playing-sound-controls">
                            <div class="playing-sound-timeline" onclick="seekAudio(event, '${id}')">
                                <div class="playing-sound-progress" style="width: ${progress}%"></div>
                            </div>
                            <div class="playing-sound-time">
                                ${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}
                            </div>
                        </div>
                    `;
                    playingSounds.appendChild(soundItem);
                } else {
                    // Only update the progress bar and time
                    const progressBar = soundItem.querySelector('.playing-sound-progress');
                    const timeDisplay = soundItem.querySelector('.playing-sound-time');
                    const playButton = soundItem.querySelector('.playing-sound-button');
                    const playIcon = playButton.querySelector('i');

                    if (progressBar) progressBar.style.width = `${progress}%`;
                    if (timeDisplay) timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
                    if (playButton) {
                        playButton.className = `playing-sound-button ${isPaused ? '' : 'active'}`;
                        playIcon.className = `fas fa-${isPaused ? 'play' : 'pause'}`;
                    }
                }
            });

            // Remove elements for sounds that are no longer playing
            const currentIds = currentSounds.map(([id]) => id);
            document.querySelectorAll('.playing-sound-item').forEach(item => {
                const id = item.getAttribute('data-id');
                if (!currentIds.includes(id)) {
                    item.remove();
                }
            });
        }

        function togglePlayPause(sampleId) {
            const audio = document.getElementById(`audio-${sampleId}`);
            if (!audio) return;

            const sample = samplesCache.find(s => s._id === sampleId);
            if (!sample) return;

            if (audio.paused) {
                // If it's a one-shot, stop other sounds
                if (sample.is_one_shot) {
                    stopAllSounds();
                }
                audio.play();
            } else {
                audio.pause();
                // Remove from active sounds to prevent auto-resume
                activeSounds.delete(sampleId);
            }
            updatePlayingSounds();
        }

        function seekAudio(event, sampleId) {
            event.preventDefault();
            event.stopPropagation();

            const audio = document.getElementById(`audio-${sampleId}`);
            if (!audio || !audio.duration) return;

            const sample = samplesCache.find(s => s._id === sampleId);
            if (!sample) return;

            const timeline = event.currentTarget;
            const rect = timeline.getBoundingClientRect();
            
            // Get the exact click position relative to the timeline's left edge
            const clickX = event.clientX - rect.left;
            
            // Calculate percentage (0 to 1) based on the timeline's width
            const percentage = clickX / rect.width;
            
            // Calculate the exact time in seconds
            const newTime = percentage * audio.duration;
            
            // Update UI
            const progress = timeline.querySelector('.playing-sound-progress');
            const timeDisplay = timeline.closest('.playing-sound-controls').querySelector('.playing-sound-time');
            
            if (progress) {
                progress.style.width = `${percentage * 100}%`;
            }
            
            if (timeDisplay) {
                timeDisplay.textContent = `${formatTime(newTime)} / ${formatTime(audio.duration)}`;
            }

            // Set the audio time
            audio.currentTime = newTime;

            // If audio was playing, ensure it continues
            if (!audio.paused) {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error('Error resuming playback:', error);
                        // If it's a looping sound, make sure the checkbox stays checked
                        if (!sample.is_one_shot) {
                            const checkbox = document.querySelector(`.element-list-item[data-id="${sampleId}"] .element-checkbox`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        }
                    });
                }
            }
        }

        function playSound(sample) {
            const audio = document.getElementById(`audio-${sample._id}`);
            if (audio) {
                // Stop all other sounds if it's a one-shot
                if (sample.is_one_shot) {
                    document.querySelectorAll('audio').forEach(otherAudio => {
                        if (otherAudio !== audio) {
                            otherAudio.pause();
                            otherAudio.currentTime = 0;
                            const otherId = otherAudio.id.split('-')[1];
                            document.querySelector(`.element-card[data-id="${otherId}"]`).classList.remove('playing');
                        }
                    });
                }
                
                // Set volume from the slider
                const volumeSlider = document.querySelector(`#audio-${sample._id}`).closest('.element-card').querySelector('.element-volume');
                audio.volume = (volumeSlider ? volumeSlider.value : 100) / 100;
                
                // Play the audio
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // Playback started successfully
                        document.querySelector(`.element-card[data-id="${sample._id}"]`).classList.add('playing');
                        currentlyPlaying.set(sample._id, sample.name);
                        updatePlayingSounds();
                    }).catch(error => {
                        // Playback failed
                        console.error('Playback failed:', error);
                        document.querySelector(`.element-card[data-id="${sample._id}"]`).classList.remove('playing');
                    });
                }
            }
        }

        function stopSound(sampleId) {
            const audio = document.getElementById(`audio-${sampleId}`);
            if (!audio) return;

            const sample = samplesCache.find(s => s._id === sampleId);
            if (!sample) return;

            // Stop the audio
            audio.pause();
            audio.currentTime = 0;
            
            // Remove from currently playing map
            currentlyPlaying.delete(sampleId);
            
            // Remove from active sounds if it's a looping sound
            if (!sample.is_one_shot) {
                activeSounds.delete(sampleId);
            }
            
            // Update the UI
            updatePlayingSounds();

            // If it's a looping sound, uncheck the checkbox
            if (!sample.is_one_shot) {
                const checkbox = document.querySelector(`.element-list-item[data-id="${sampleId}"] .element-checkbox`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            } else {
                // If it's a one-shot, remove active state from button
                const button = document.querySelector(`.element-list-item[data-id="${sampleId}"] .one-shot-button`);
                if (button) {
                    button.classList.remove('active');
                }
            }

            // Remove playing class from the list item
            const listItem = document.querySelector(`.element-list-item[data-id="${sampleId}"]`);
            if (listItem) {
                listItem.classList.remove('playing');
            }
        }

        function stopAllSounds() {
            document.querySelectorAll('audio').forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            currentlyPlaying.clear();
            updatePlayingSounds();
        }

        // Global audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentAudio = null;
        let samplesCache = [];
        let currentAudioUrl = null;
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const audioCurrentTime = document.getElementById('audioCurrentTime');
        const audioDuration = document.getElementById('audioDuration');

        function setupAudioPlayer() {
            audioPlayer.addEventListener('timeupdate', () => {
                audioCurrentTime.textContent = formatTime(audioPlayer.currentTime);
            });
            audioPlayer.addEventListener('durationchange', () => {
                audioDuration.textContent = formatTime(audioPlayer.duration);
            });
            audioPlayer.addEventListener('ended', () => {
                audioPlayerContainer.style.display = 'none';
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function stopAudio() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayerContainer.style.display = 'none';
        }

        let sampleToDelete = null;

        function showDeleteConfirmation(sampleId) {
            sampleToDelete = sampleId;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (sampleToDelete) {
                await deleteSample(sampleToDelete);
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                sampleToDelete = null;
            }
        });

        function organizeSamplesByMood(samples) {
            const moods = {
                'ambient': { 
                    title: 'Ambient', 
                    samples: [],
                    oneShots: []
                },
                'battle': { 
                    title: 'Battle', 
                    samples: [],
                    oneShots: []
                },
                'town': { 
                    title: 'Town', 
                    samples: [],
                    oneShots: []
                },
                'dungeon': { 
                    title: 'Dungeon', 
                    samples: [],
                    oneShots: []
                },
                'other': { 
                    title: 'Other', 
                    samples: [],
                    oneShots: []
                }
            };

            samples.forEach(sample => {
                const category = sample.category.toLowerCase();
                let mood = 'other';
                
                if (category.includes('ambient') || category.includes('nature')) mood = 'ambient';
                else if (category.includes('battle') || category.includes('combat')) mood = 'battle';
                else if (category.includes('town') || category.includes('city')) mood = 'town';
                else if (category.includes('dungeon') || category.includes('cave')) mood = 'dungeon';

                if (sample.is_one_shot) {
                    moods[mood].oneShots.push(sample);
                } else {
                    moods[mood].samples.push(sample);
                }
            });

            return moods;
        }

        let activeSounds = new Map(); // Map to store active sound intervals
        const DEFAULT_MIN_DELAY = 1;
        const DEFAULT_MAX_DELAY = 15;

        function toggleSound(sample, isChecked) {
            const audio = document.getElementById(`audio-${sample._id}`);
            if (!audio) return;

            if (isChecked) {
                // If it's a one-shot, stop other sounds
                if (sample.is_one_shot) {
                    stopAllSounds();
                }

                // Get delay range from inputs or use defaults
                const minDelayInput = document.getElementById(`min-delay-${sample._id}`);
                const maxDelayInput = document.getElementById(`max-delay-${sample._id}`);
                const minDelay = minDelayInput ? parseInt(minDelayInput.value) || DEFAULT_MIN_DELAY : DEFAULT_MIN_DELAY;
                const maxDelay = maxDelayInput ? parseInt(maxDelayInput.value) || DEFAULT_MAX_DELAY : DEFAULT_MAX_DELAY;

                // Set volume from the slider
                const volumeSlider = audio.closest('.element-list-item').querySelector('.element-volume');
                audio.volume = (volumeSlider ? volumeSlider.value : 100) / 100;

                // Function to play the sound with random delay
                const playWithRandomDelay = () => {
                    if (!activeSounds.has(sample._id)) return; // Stop if sound was deactivated

                    const delay = Math.floor(Math.random() * (maxDelay - minDelay + 1)) + minDelay;
                    setTimeout(() => {
                        const checkbox = document.querySelector(`.element-list-item[data-id="${sample._id}"] .element-checkbox`);
                        if (checkbox && checkbox.checked && activeSounds.has(sample._id)) {
                            const playPromise = audio.play();
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    currentlyPlaying.set(sample._id, sample.name);
                                    updatePlayingSounds();
                                    // Schedule next play only if it's not a one-shot and still active
                                    if (!sample.is_one_shot && activeSounds.has(sample._id)) {
                                        playWithRandomDelay();
                                    }
                                }).catch(error => {
                                    console.error('Playback failed:', error);
                                    if (sample.is_one_shot) {
                                        checkbox.checked = false;
                                    }
                                });
                            }
                        }
                    }, delay * 1000); // Convert to milliseconds
                };

                // Start the random playback cycle
                activeSounds.set(sample._id, true);
                playWithRandomDelay();

            } else {
                // Stop the sound and clear any pending timeouts
                audio.pause();
                audio.currentTime = 0;
                currentlyPlaying.delete(sample._id);
                activeSounds.delete(sample._id);
                updatePlayingSounds();
            }
        }

        function toggleOneShot(sample) {
            const audio = document.getElementById(`audio-${sample._id}`);
            if (!audio) return;

            const playButton = document.querySelector(`.element-list-item[data-id="${sample._id}"] .one-shot-button`);
            const isPlaying = playButton.classList.contains('active');

            if (isPlaying) {
                // Stop the sound
                audio.pause();
                audio.currentTime = 0;
                currentlyPlaying.delete(sample._id);
                updatePlayingSounds();
                playButton.classList.remove('active');
            } else {
                // Stop only other one-shot sounds
                document.querySelectorAll('audio').forEach(otherAudio => {
                    const otherId = otherAudio.id.split('-')[1];
                    const otherSample = samplesCache.find(s => s._id === otherId);
                    if (otherSample && otherSample.is_one_shot && otherId !== sample._id) {
                        otherAudio.pause();
                        otherAudio.currentTime = 0;
                        currentlyPlaying.delete(otherId);
                        const otherButton = document.querySelector(`.element-list-item[data-id="${otherId}"] .one-shot-button`);
                        if (otherButton) {
                            otherButton.classList.remove('active');
                        }
                    }
                });
                
                // Set volume from the slider
                const volumeSlider = audio.closest('.element-list-item').querySelector('.element-volume');
                audio.volume = (volumeSlider ? volumeSlider.value : 100) / 100;

                // Play the sound
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        currentlyPlaying.set(sample._id, sample.name);
                        updatePlayingSounds();
                        playButton.classList.add('active');
                    }).catch(error => {
                        console.error('Playback failed:', error);
                        playButton.classList.remove('active');
                    });
                }
            }
        }

        function updateCircularProgress(audio, progressId) {
            const progress = document.getElementById(progressId);
            if (!progress) return;
            
            const percent = (audio.currentTime / audio.duration) * 100;
            const circumference = 2 * Math.PI * 17; // radius = 17
            const offset = circumference - (percent / 100) * circumference;
            
            progress.style.strokeDashoffset = offset;
        }

        async function loadSamples() {
            try {
                const response = await fetch('/api/samples');
                const samples = await response.json();
                samplesCache = samples;
                
                const soundsetsContainer = document.getElementById('soundsetsContainer');
                const moods = organizeSamplesByMood(samples);
                
                soundsetsContainer.innerHTML = Object.entries(moods).map(([key, mood]) => `
                    <div class="soundset-card">
                        <h3 class="mood-title">${mood.title}</h3>
                        
                        ${mood.samples.length > 0 ? `
                            <div class="section-title">
                                <h4><i class="fas fa-sync"></i> Ambient Sounds</h4>
                            </div>
                            <ul class="element-list">
                                ${mood.samples.map(sample => `
                                    <li class="element-list-item" data-id="${sample._id}">
                                        <div class="circular-progress">
                                            <svg width="40" height="40">
                                                <circle class="bg" cx="20" cy="20" r="17" />
                                                <circle class="progress" id="progress-${sample._id}" cx="20" cy="20" r="17" 
                                                        stroke-dasharray="106.8" stroke-dashoffset="106.8" />
                                            </svg>
                                        </div>
                                        <input type="checkbox" class="element-checkbox" 
                                               onchange="toggleSound(${JSON.stringify(sample).replace(/"/g, '&quot;')}, this.checked)">
                                        <div class="element-info">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">${sample.name}</h5>
                                                <span class="badge bg-info">Loop</span>
                                            </div>
                                            <small class="text-muted">${sample.category}</small>
                                        </div>
                                        <div class="element-controls">
                                            <div class="element-volume-container">
                                                <input type="range" class="element-volume" 
                                                       min="0" max="100" value="100"
                                                       onchange="updateElementVolume('${sample._id}', this.value)">
                                            </div>
                                            <div class="delay-range">
                                                <input type="number" id="min-delay-${sample._id}" 
                                                       value="${DEFAULT_MIN_DELAY}" min="1" max="1000"
                                                       onchange="validateDelayRange('${sample._id}')">
                                                <span>-</span>
                                                <input type="number" id="max-delay-${sample._id}" 
                                                       value="${DEFAULT_MAX_DELAY}" min="1" max="1000"
                                                       onchange="validateDelayRange('${sample._id}')">
                                                <span>sec</span>
                                            </div>
                                            <div class="element-time">
                                                <span id="current-${sample._id}">0:00</span> / 
                                                <span id="duration-${sample._id}">0:00</span>
                                            </div>
                                            <div class="element-actions">
                                                <button class="btn btn-primary btn-icon" onclick="showEditModal('${sample._id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-icon" onclick="showDeleteConfirmation('${sample._id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <audio id="audio-${sample._id}" style="display: none;" preload="auto">
                                            <source src="/api/audio/${sample.filename}" type="audio/mpeg">
                                        </audio>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                        
                        ${mood.oneShots.length > 0 ? `
                            <div class="section-title">
                                <h4><i class="fas fa-bolt"></i> One-Shot Sounds</h4>
                            </div>
                            <ul class="element-list">
                                ${mood.oneShots.map(sample => `
                                    <li class="element-list-item" data-id="${sample._id}">
                                        <div class="circular-progress">
                                            <svg width="40" height="40">
                                                <circle class="bg" cx="20" cy="20" r="17" />
                                                <circle class="progress" id="progress-${sample._id}" cx="20" cy="20" r="17" 
                                                        stroke-dasharray="106.8" stroke-dashoffset="106.8" />
                                            </svg>
                                        </div>
                                        <button class="btn btn-primary one-shot-button" onclick="toggleOneShot(${JSON.stringify(sample).replace(/"/g, '&quot;')})">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <div class="element-info">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">${sample.name}</h5>
                                                <span class="badge bg-warning">One-shot</span>
                                            </div>
                                            <small class="text-muted">${sample.category}</small>
                                        </div>
                                        <div class="element-controls">
                                            <div class="element-volume-container">
                                                <input type="range" class="element-volume" 
                                                       min="0" max="100" value="100"
                                                       onchange="updateElementVolume('${sample._id}', this.value)">
                                            </div>
                                            <div class="element-time">
                                                <span id="current-${sample._id}">0:00</span> / 
                                                <span id="duration-${sample._id}">0:00</span>
                                            </div>
                                            <div class="element-actions">
                                                <button class="btn btn-primary btn-icon" onclick="showEditModal('${sample._id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-icon" onclick="showDeleteConfirmation('${sample._id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <audio id="audio-${sample._id}" style="display: none;" preload="auto">
                                            <source src="/api/audio/${sample.filename}" type="audio/mpeg">
                                        </audio>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `).join('');
                
                // Setup audio event listeners
                document.querySelectorAll('audio').forEach(audio => {
                    const id = audio.id.split('-')[1];
                    setupAudioSeeking(audio, id);
                    
                    audio.addEventListener('timeupdate', () => {
                        const currentTime = document.getElementById(`current-${id}`);
                        if (currentTime) {
                            currentTime.textContent = formatTime(audio.currentTime);
                        }
                        updateCircularProgress(audio, `progress-${id}`);
                        
                        // Only update playing sounds if not currently seeking
                        const timeline = document.querySelector(`.playing-sound-item[data-id="${id}"] .playing-sound-timeline`);
                        if (!timeline || !timeline.classList.contains('seeking')) {
                            updatePlayingSounds();
                        }
                    });
                    
                    audio.addEventListener('durationchange', () => {
                        const duration = document.getElementById(`duration-${id}`);
                        if (duration) {
                            duration.textContent = formatTime(audio.duration);
                        }
                    });
                    
                    audio.addEventListener('play', () => {
                        const item = document.querySelector(`.element-list-item[data-id="${id}"]`);
                        if (item) {
                            item.classList.add('playing');
                        }
                    });
                    
                    audio.addEventListener('pause', () => {
                        const item = document.querySelector(`.element-list-item[data-id="${id}"]`);
                        if (item) {
                            item.classList.remove('playing');
                        }
                    });
                    
                    audio.addEventListener('ended', () => {
                        const item = document.querySelector(`.element-list-item[data-id="${id}"]`);
                        if (item) {
                            item.classList.remove('playing');
                            const sample = samplesCache.find(s => s._id === id);
                            if (sample && sample.is_one_shot) {
                                const checkbox = item.querySelector('.element-checkbox');
                                if (checkbox) {
                                    checkbox.checked = false;
                                }
                            }
                        }
                        currentlyPlaying.delete(id);
                        updatePlayingSounds();
                    });
                });
                
                populateSceneSamplesList();
            } catch (error) {
                console.error('Error loading samples:', error);
            }
        }

        async function uploadSample() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            try {
                const response = await fetch('/api/samples', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    form.reset();
                    loadSamples();
                } else {
                    alert('Error uploading sample');
                }
            } catch (error) {
                console.error('Error uploading sample:', error);
                alert('Error uploading sample');
            }
        }

        async function deleteSample(sampleId) {
            try {
                const response = await fetch(`/api/samples/${sampleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (response.ok) {
                    loadSamples();
                } else {
                    alert(`Error deleting sample: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting sample:', error);
                alert('Error deleting sample. Please try again.');
            }
        }

        // Enhanced scene type suggestions with more detailed categories and moods
        const sceneTypeSuggestions = {
            'ambient': {
                keywords: ['nature', 'wind', 'rain', 'forest', 'night', 'ambient', 'atmosphere', 'environment'],
                moods: ['peaceful', 'calm', 'serene', 'tranquil'],
                description: 'Natural and environmental sounds that create atmosphere'
            },
            'battle': {
                keywords: ['sword', 'combat', 'magic', 'fire', 'shout', 'battle', 'fight', 'war', 'weapon', 'spell'],
                moods: ['intense', 'epic', 'dramatic', 'action'],
                description: 'Combat and action sounds for intense scenes'
            },
            'town': {
                keywords: ['crowd', 'market', 'smith', 'tavern', 'street', 'city', 'village', 'people', 'activity'],
                moods: ['lively', 'busy', 'social', 'urban'],
                description: 'Urban and social sounds for populated areas'
            },
            'dungeon': {
                keywords: ['drip', 'echo', 'creak', 'monster', 'footsteps', 'dungeon', 'cave', 'underground', 'dark'],
                moods: ['mysterious', 'eerie', 'tense', 'dark'],
                description: 'Atmospheric sounds for underground and dark locations'
            },
            'custom': {
                keywords: [],
                moods: [],
                description: 'Create your own custom scene'
            }
        };

        function suggestSamples() {
            const sceneType = document.getElementById('sceneType').value;
            const suggestions = sceneTypeSuggestions[sceneType];
            
            // Clear current selections
            document.querySelectorAll('input[name="scene_samples"]:checked').forEach(cb => {
                cb.checked = false;
            });
            
            // Get all samples that match the scene type
            const matchingSamples = samplesCache.filter(sample => {
                const sampleCategory = sample.category.toLowerCase();
                const sampleName = sample.name.toLowerCase();
                
                // Check if sample matches any keywords
                return suggestions.keywords.some(keyword => 
                    sampleCategory.includes(keyword) || sampleName.includes(keyword)
                );
            });

            // Sort samples by relevance (number of keyword matches)
            matchingSamples.sort((a, b) => {
                const aMatches = suggestions.keywords.filter(keyword => 
                    a.category.toLowerCase().includes(keyword) || 
                    a.name.toLowerCase().includes(keyword)
                ).length;
                const bMatches = suggestions.keywords.filter(keyword => 
                    b.category.toLowerCase().includes(keyword) || 
                    b.name.toLowerCase().includes(keyword)
                ).length;
                return bMatches - aMatches;
            });

            // Select the most relevant samples (up to 5)
            matchingSamples.slice(0, 5).forEach(sample => {
                const checkbox = document.getElementById(`scene-sample-${sample._id}`);
                if (checkbox) checkbox.checked = true;
            });

            // Update the selected samples list
            updateSelectedSamplesList();

            // Show feedback about the suggestions
            const feedback = document.createElement('div');
            feedback.className = 'alert alert-info mt-3';
            feedback.innerHTML = `
                <strong>Suggested ${suggestions.description}</strong><br>
                Selected ${matchingSamples.slice(0, 5).length} most relevant sounds.
                ${matchingSamples.length > 5 ? `(${matchingSamples.length - 5} more available)` : ''}
            `;
            
            // Remove any existing feedback
            const existingFeedback = document.querySelector('.alert-info');
            if (existingFeedback) existingFeedback.remove();
            
            // Add the new feedback
            document.getElementById('sceneSamplesList').parentNode.appendChild(feedback);
        }

        function updateSelectedSamplesList() {
            const selectedSamplesList = document.getElementById('selectedSamplesList');
            const selectedSamples = Array.from(document.querySelectorAll('input[name="scene_samples"]:checked'))
                .map(cb => {
                    const sample = samplesCache.find(s => s._id === cb.value);
                    return sample;
                });

            selectedSamplesList.innerHTML = selectedSamples.map(sample => `
                <div class="d-flex align-items-center mb-2">
                    <div class="flex-grow-1">
                        <div>${sample.name}</div>
                        <small class="text-muted">${sample.category}</small>
                    </div>
                    <div class="ms-2">
                        <input type="range" class="form-range" min="0" max="100" value="100" 
                               onchange="updateSampleVolume('${sample._id}', this.value)">
                    </div>
                </div>
            `).join('');
        }

        function updateSampleVolume(sampleId, volume) {
            const audioElement = document.getElementById(`audio-${sampleId}`);
            if (audioElement) {
                audioElement.volume = volume / 100;
            }
        }

        function populateSceneSamplesList() {
            const sceneSamplesList = document.getElementById('sceneSamplesList');
            if (!sceneSamplesList) return;
            
            sceneSamplesList.innerHTML = samplesCache.map(sample => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${sample._id}" 
                           id="scene-sample-${sample._id}" name="scene_samples"
                           onchange="updateSelectedSamplesList()">
                    <label class="form-check-label" for="scene-sample-${sample._id}">
                        ${sample.name} (${sample.category})
                    </label>
                </div>
            `).join('');
        }

        function updateElementVolume(sampleId, volume) {
            const audio = document.getElementById(`audio-${sampleId}`);
            if (audio) {
                audio.volume = volume / 100;
            }
        }

        function validateDelayRange(sampleId) {
            const minInput = document.getElementById(`min-delay-${sampleId}`);
            const maxInput = document.getElementById(`max-delay-${sampleId}`);
            
            let min = parseInt(minInput.value) || DEFAULT_MIN_DELAY;
            let max = parseInt(maxInput.value) || DEFAULT_MAX_DELAY;
            
            // Ensure min is not greater than max
            if (min > max) {
                [min, max] = [max, min];
            }
            
            // Ensure values are within bounds
            min = Math.max(1, Math.min(1000, min));
            max = Math.max(1, Math.min(1000, max));
            
            minInput.value = min;
            maxInput.value = max;
        }

        async function loadScenes() {
            try {
                const response = await fetch('/api/scenes');
                const scenes = await response.json();
                const scenesList = document.getElementById('scenesList');
                scenesList.innerHTML = scenes.map(scene => `
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${scene.name}</h5>
                                <p class="card-text">
                                    ${scene.description || ''}<br>
                                    <small class="text-muted">Type: ${scene.type}</small>
                                </p>
                                <div class="d-flex justify-content-between">
                                    <button class="btn btn-primary btn-sm" onclick="playScene('${scene._id}')">
                                        <i class="fas fa-play"></i> Play Scene
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="showDeleteSceneConfirmation('${scene._id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading scenes:', error);
            }
        }

        async function createScene() {
            const form = document.getElementById('sceneForm');
            const formData = new FormData(form);
            const selectedSamples = Array.from(document.querySelectorAll('input[name="scene_samples"]:checked'))
                .map(cb => ({
                    id: cb.value,
                    volume: 100
                }));

            const sceneData = {
                name: formData.get('name'),
                description: formData.get('description'),
                type: formData.get('scene_type'),
                samples: selectedSamples
            };

            try {
                const response = await fetch('/api/scenes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sceneData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('sceneModal')).hide();
                    form.reset();
                    loadScenes();
                } else {
                    alert('Error creating scene');
                }
            } catch (error) {
                console.error('Error creating scene:', error);
                alert('Error creating scene');
            }
        }

        async function playScene(sceneId) {
            try {
                const response = await fetch('/api/scenes');
                const scenes = await response.json();
                const scene = scenes.find(s => s._id === sceneId);
                
                if (scene && scene.samples && scene.samples.length > 0) {
                    // Play all selected samples with their respective volumes
                    scene.samples.forEach(sample => {
                        const audioElement = document.getElementById(`audio-${sample.id}`);
                        if (audioElement) {
                            audioElement.volume = sample.volume / 100;
                            audioElement.play();
                        }
                    });
                } else {
                    alert('No samples in this scene.');
                }
            } catch (error) {
                console.error('Error playing scene:', error);
                alert('Error playing scene');
            }
        }

        let sceneToDelete = null;

        function showDeleteSceneConfirmation(sceneId) {
            sceneToDelete = sceneId;
            const deleteSceneModal = new bootstrap.Modal(document.getElementById('deleteSceneModal'));
            deleteSceneModal.show();
        }

        document.getElementById('confirmDeleteSceneBtn').addEventListener('click', async function() {
            if (sceneToDelete) {
                await deleteScene(sceneToDelete);
                bootstrap.Modal.getInstance(document.getElementById('deleteSceneModal')).hide();
                sceneToDelete = null;
            }
        });

        async function deleteScene(sceneId) {
            try {
                const response = await fetch(`/api/scenes/${sceneId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (response.ok) {
                    loadScenes();
                } else {
                    alert(`Error deleting scene: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting scene:', error);
                alert('Error deleting scene. Please try again.');
            }
        }

        function showEditModal(sampleId) {
            const sample = samplesCache.find(s => s._id === sampleId);
            if (!sample) {
                alert('Error: Sample not found');
                return;
            }

            // Validate sample data before populating the form
            if (!sample.name || !sample.category) {
                alert('Error: Invalid sample data');
                return;
            }

            document.getElementById('editSampleId').value = sample._id;
            document.getElementById('editName').value = sample.name;
            document.getElementById('editCategory').value = sample.category;
            document.getElementById('editIsOneShot').checked = sample.is_one_shot;

            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }

        async function updateSample() {
            const form = document.getElementById('editForm');
            const sampleId = document.getElementById('editSampleId').value;
            const name = document.getElementById('editName').value.trim();
            const category = document.getElementById('editCategory').value;
            
            // Frontend validation
            if (!sampleId) {
                alert('Error: Sample ID is missing');
                return;
            }

            if (!name) {
                alert('Please enter a name for the sample');
                return;
            }

            if (!category) {
                alert('Please select a category');
                return;
            }

            const sampleData = {
                name: name,
                category: category,
                is_one_shot: document.getElementById('editIsOneShot').checked
            };

            try {
                const response = await fetch(`/api/samples/${sampleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sampleData)
                });

                const data = await response.json();

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    loadSamples(); // Reload the samples to show updated data
                } else {
                    alert(`Error updating sample: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating sample:', error);
                alert('Error updating sample. Please try again.');
            }
        }

        // Add this function to handle audio seeking events
        function setupAudioSeeking(audio, sampleId) {
            const sample = samplesCache.find(s => s._id === sampleId);
            if (!sample) return;

            audio.addEventListener('seeking', () => {
                const timeline = document.querySelector(`.playing-sound-item[data-id="${sampleId}"] .playing-sound-timeline`);
                if (timeline) {
                    timeline.classList.add('seeking');
                }
            });

            audio.addEventListener('seeked', () => {
                const timeline = document.querySelector(`.playing-sound-item[data-id="${sampleId}"] .playing-sound-timeline`);
                if (timeline) {
                    timeline.classList.remove('seeking');
                }
                // Ensure the sound continues playing if it's a looping sound
                if (!sample.is_one_shot && !audio.paused) {
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error('Error resuming playback after seeking:', error);
                            // Keep the checkbox checked for looping sounds
                            const checkbox = document.querySelector(`.element-list-item[data-id="${sampleId}"] .element-checkbox`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
            });
        }
    </script>
</body>
</html>